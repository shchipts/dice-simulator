;   Copyright (c) 2021 International Institute for Applied Systems Analysis.
;   All rights reserved. The use and distribution terms for this software
;   are covered by the MIT License (http://opensource.org/licenses/MIT)
;   which can be found in the file LICENSE at the root of this distribution.
;   By using this software in any fashion, you are agreeing to be bound by
;   the terms of this license.
;   You must not remove this notice, or any other, from this software.

(ns dice-simulator.compute.translator-test
  (:require [clojure.test :refer :all]
            [dice-simulator.compute.translator :refer :all]
            [utilities-clj.floating-point-comparison :refer :all]))

;;; tests

(deftest net-emissions-ffi-test
  (testing "linear-logistic curve of net emissions"
    (; Act
     let [out1 (net-emissions-ffi [35.85 36 2020 -1 15 50] (range 2015 2101))
          out2 (net-emissions-ffi [35.85 51 2060 -20 20 60] (range 2015 2101 5))
          out3 (net-emissions-ffi [35.85 42 2030 -9 20 50] (range 2015 2101 5))]

      ; Assert
      (is (real= out1
                 [35.85 35.86 35.87 35.88 35.89 35.9 34.16236139 32.42472278
                  30.68708416 28.94944555 27.21180694 26.40526725 25.55131989
                  24.65209155 23.71059817 22.73075582 21.71735588 20.67600134
                  19.6130038 18.53524377 17.45 16.36475623 15.2869962
                  14.22399866 13.18264412 12.16924418 11.18940183 10.24790845
                  9.348680114 8.494732752 7.68819306 6.930340092 6.22167123
                  5.561985695 4.950478868 4.385841352 3.86635759 3.390000005
                  2.954515694 2.557503807 2.196482614 1.868946009 1.57240976
                  1.304448194 1.062722254 0.845 0.649170639 0.473253172
                  0.315400636 0.173900863 0.047174519 -0.066228878 -0.167636412
                  -0.258258209 -0.339194516 -0.411443084 -0.475906659
                  -0.533400384 -0.584658987 -0.630343676 -0.671048666
                  -0.707307308 -0.739597801 -0.768348479 -0.793942683
                  -0.816723225 -0.836996466 -0.855036027 -0.87108616
                  -0.885364796 -0.898066298 -0.909363951 -0.919412189
                  -0.928348611 -0.936295784 -0.943362857 -0.94964701
                  -0.955234754 -0.960203088 -0.964620534 -0.968548063
                  -0.972039922 -0.975144369 -0.977904331 -0.980357991
                  -0.982539308]))
      (is (real= out2
                 [35.85000000 40.90000000 45.95000000 51.00000000 56.05000000
                  61.10000000 66.15000000 71.20000000 76.25000000 81.30000000
                  62.39686317 53.68579368 42.83443510 30.65000000 18.46556490
                  7.61420632 -1.09686317 -7.52519492]))
      (is (real= out3
                 [35.85 37.9 39.95 42 34.55615423 29.99192829 23.7986056 16.5
                  9.201394399 3.00807171 -1.55615423 -4.582097201 -6.45
                  -7.552685624 -8.186547351 -8.545351814 -8.746690636
                  -8.859116022])))))

(deftest baseline-emissions-ffi-test
  (testing "baseline emissions with no climate change and no abatement"
    (; Act
     let [ssp1 (baseline-emissions-ffi :SSP1 (range 2015 2101 5))
          ssp2 (baseline-emissions-ffi :SSP2 (range 2015 2101 5))
          ssp3 (baseline-emissions-ffi :SSP3 (range 2015 2101 5))
          ssp4 (baseline-emissions-ffi :SSP4 (range 2015 2101 5))
          ssp5 (baseline-emissions-ffi :SSP5 (range 2015 2101 5))]

      ; Assert
      (is (real= ssp1
                 [34.436860 36.892236 38.286256 39.680275 40.770526 41.860776
                  42.264693 42.668610 42.853454 43.038298 41.987351 40.936403
                  38.134442 35.332481 32.982921 30.633360 28.841182 27.049004]))
      (is (real= ssp2
                 [35.140610 37.148025 39.827663 42.507302 45.124009 47.740715
                  50.677593 53.614471 56.540779 59.467088 62.278246 65.089405
                  69.578691 74.067978 77.672463 81.276948 83.721358 86.165768]))
      (is (real= ssp3
                 [36.863002 41.088257 45.123586 49.158915 52.199182 55.239448
                  57.722961 60.206474 62.214590 64.222706 66.351677 68.480648
                  70.604401 72.728153 75.150200 77.572247 80.065546 82.558844]))
      (is (real= ssp4
                 [36.532238 40.417488 44.055912 47.694335 49.642782 51.591229
                  52.334744 53.078259 53.385109 53.691960 53.310941 52.929922
                  51.175366 49.420810 47.998013 46.575217 45.452270 44.329322]))
      (is (real= ssp5
                 [35.875000 39.550000 45.355000 51.160000 58.500000 65.840000
                  73.985000 82.130000 91.665000 101.200000 109.450000 117.700000
                  123.650000 129.600000 130.250000 130.900000 129.250000
                  127.600000])))))

(deftest net-emissions-land-use-test
  (testing "SSP-based net land use emissions"
    (; Act
     let [ssp1 (net-emissions-land-use :SSP1 :1.9 (range 2015 2101 5))
          ssp2 (net-emissions-land-use :SSP2 :4.5 (range 2015 2101 5))
          ssp3 (net-emissions-land-use :SSP3 :6.0 (range 2015 2101 5))
          ssp4 (net-emissions-land-use :SSP4 :baseline (range 2015 2101 5))
          ssp5 (net-emissions-land-use :SSP5 :2.6 (range 2015 2101 5))]

      ; Assert
      (is (real= ssp1
                 [3.08100003 2.65466123 1.58995046 0.52523969 0.79821356
                  1.07118744 0.21469723 -0.64179298 -0.98741768 -1.33304239
                  -1.51437013 -1.69569787 -1.88953381 -2.08336974 -2.23495961
                  -2.38654948 -2.38545615 -2.38436283]))
      (is (real= ssp2
                 [6.41591589 5.67038800 5.12943906 4.58849012 3.88306150
                  3.17763288 1.92992128 0.68220967 -0.63673652 -1.95568271
                  -2.29315730 -2.63063189 -3.21602897 -3.80142605 -4.18043837
                  -4.55945068 -4.67976382 -4.80007697]))
      (is (real= ssp3
                 [7.03152965 7.14447910 6.45586860 5.76725810 4.97070745
                  4.17415680 3.94588785 3.71761890 4.04162895 4.36563900
                  4.02579485 3.68595070 3.09831650 2.51068230 2.44857425
                  2.38646620 2.50875475 2.63104330]))
      (is (real= ssp4
                 [2.17366251 1.21853901 1.29688701 1.37523502 1.81546742
                  2.25569982 2.42093931 2.58617881 2.92409795 3.26201710
                  3.11515163 2.96828616 2.36019976 1.75211335 1.35480745
                  0.95750154 0.70645059 0.45539964]))
      (is (real= ssp5
                 [2.65862865 1.18225230 1.36545030 1.54864830 1.89881250
                  2.24897670 3.04062525 3.83227380 3.76577530 3.69927680
                  2.96997360 2.24067040 1.65649895 1.07232750 0.78988580
                  0.50744410 0.35472945 0.20201480])))))

(deftest ssp-emissions-ffi-test
  (testing "SSP-based net FFI emissions"
    (; Act
     let [ssp (ssp-emissions-ffi :SSP2 :4.5 (range 2015 2101 5))]

      ; Assert
      (is (real= ssp
                 [34.87369539 36.61454074 38.20585254 39.79716435 40.55555113
                  41.3139379 41.73194219 42.14994647 41.57400946 40.99807244
                  38.91096114 36.82384984 33.22454699 29.62524414 24.8266117
                  20.02797927 16.97155147 13.91512367])))))
